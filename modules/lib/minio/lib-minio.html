<!doctype html>
<html>
 <head> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <!-- No caching headers --> 
  <meta http-equiv="cache-control" content="no-cache"> 
  <meta http-equiv="pragma" content="no-cache"> 
  <meta http-equiv="expires" content="-1"> 
  <title>Minio</title> 
  <link rel="icon" type="image/png" href="../../../images/incode-favicon.png"> 
  <!--
        Based on DataNucleus' template,
        that was in turn based on an earlier version of Apache Isis' template,
        that was in turn based on Apache Deltaspike's template.

        This template uses
        * Bootstrap v3.3.7 (https://getbootstrap.com/) for navbar.
        * Bootstrap TOC plugin v0.4.1 (https://afeld.github.io/bootstrap-toc/)
          for the table of contents.
        * jQuery (necessary for Bootstrap's JavaScript plugins)
        * Font-Awesome for some icons used by Asciidoctor

        Also:
        * Bootswatch "flatly" theme for Bootstrap (https://bootswatch.com/flatly).
        * slick.js (carousel)
        * add a link to all headers (home-grown, adapted from blog posts)
        * integration of elasticlunr.js (home-grown, adapted from blog posts)
    --> 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"> 
  <link href="../../../css/bootstrap-toc/0.4.1/bootstrap-toc.min.css" rel="stylesheet"> 
  <link href="../../../css/asciidoctor/foundation.css" rel="stylesheet"> 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet"> 
  <link href="../../../css/slick/1.5.0/slick.css" rel="stylesheet"> 
  <link href="../../../css/slick/1.5.0/slick-theme.css" rel="stylesheet"> 
  <link href="../../../css/search-panel/search-panel.css" rel="stylesheet"> 
  <link href="../../../css/header-links/header-links.css" rel="stylesheet"> 
  <link href="../../../css/sticky-header/sticky-header.css" rel="stylesheet"> 
  <link href="../../../css/customisations.css" rel="stylesheet"> 
  <!-- Coderay syntax formatter --> 
  <style type="text/css">
        /* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
    </style> 
 </head> 
 <body data-spy="scroll" data-target="#toc"> 
  <div id="basedir" style="display:none;">
   ../../../
  </div> 
  <div id="docname" style="display:none;">
   lib-minio
  </div> 
  <div id="filetype" style="display:none;">
   html
  </div> 
  <!-- Navbar --> 
  <nav class="navbar navbar-default navbar-static-top header"> 
   <div class="container"> 
    <div class="navbar-header"> 
     <!-- Three line menu button for use on mobile screens --> 
     <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> 
     <a class="navbar-brand" href="../../../index.html"> <img alt="Brand" src="../../../images/incode-logo-66x52.png"> </a> 
     <a class="navbar-brand" href="../../../index.html">Incode Platform</a> 
    </div> 
    <!-- Navbar that will collapse on mobile screens --> 
    <div id="navbar" class="navbar-collapse collapse"> 
     <ul class="nav navbar-nav"> 
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Quickstart<span class="caret"></span></a> 
       <ul class="dropdown-menu"> 
        <li><a href="../../../quickstart/quickstart.html">Quickstart App</a></li> 
       </ul> </li> 
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Modules<span class="caret"></span></a> 
       <ul class="dropdown-menu"> 
        <li><a href="../../../modules/incode-parent.html">Parent POM</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">Modules</li> 
        <li><a href="../../../modules/dom/dom.html">(Sub)domains</a></li> 
        <li><a href="../../../modules/ext/ext.html">Extensions</a></li> 
        <li><a href="../../../modules/lib/lib.html">Libraries</a></li> 
        <li><a href="../../../modules/mml/mml.html">MetaModel Facets</a></li> 
        <li><a href="../../../modules/spi/spi.html">SPI Implementations</a></li> 
        <li><a href="../../../modules/wkt/wkt.html">Wicket Components</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">Examples</li> 
       </ul> </li> 
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Other Resources<span class="caret"></span></a> 
       <ul class="dropdown-menu"> 
        <li class="dropdown-header">Build &amp; Maven-mixins</li> 
        <li><a href="https://github.com/incodehq/incode-build">Incode Build</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">Examples (to fork)</li> 
        <li><a href="https://github.com/incodehq/incode-camel">Incode Camel</a></li> 
        <li><a href="https://github.com/incodehq/incode-examples">Incode (Sub)domain Examples</a></li> 
       </ul> </li> 
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Support<span class="caret"></span></a> 
       <ul class="dropdown-menu"> 
        <li class="dropdown-header">Source code</li> 
        <li class="dropdown-header">Source code</li> 
        <li><a href="https://github.com/incodehq/incode-platform">Github</a></li> 
        <li><a href="https://github.com/incodehq/incode-platform/issues">Issue Tracker</a></li> 
        <li><a href="../../../pages/change-log/change-log.html">Change Log</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">CI &amp; Binaries</li> 
        <li><a href="https://gitlab.com/incodehq-public/incode-platform">Gitlab Mirror (CI)</a></li> 
        <li><a href="https://repo.incode.cloud">repo.incode.cloud (Nexus Repo)</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">Guides</li> 
        <li><a href="../../../pages/contributors-guide/contributors-guide.html">Contributors guide</a></li> 
        <li><a href="../../../pages/committers-guide/committers-guide.html">Committers guide</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">Other</li> 
        <li><a href="../../../pages/license.html">License</a></li> 
        <li><a href="../../../pages/thanks.html">Thanks</a></li> 
       </ul> </li> 
     </ul> 
     <div class="nav navbar-nav navbar-right"> 
      <!-- 'style' added to fix height of input box. FIX THIS --> 
      <form class="navbar-form" role="search" id="search-form" style="padding: 1px 15px;"> 
       <div class="form-group"> 
        <input class="form-control" id="search-field" type="text" size="30" placeholder="Search"> 
       </div> 
      </form> 
     </div> 
    </div> 
   </div> 
  </nav> 
  <div class="container"> 
   <div class="row-fluid"> 
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-9"> 
     <div id="search-panel"> 
      <div id="search-results"></div> 
      <div> 
       <br> 
       <a href="#" id="search-results-clear">clear</a> 
      </div> 
     </div> 
     <span class="pdf-link"><a href="lib-minio.pdf"><img src="../../../images/PDF-50.png"></a></span> 
     <div class="page-title"> 
      <h1>Minio</h1> 
     </div> 
     <div id="doc-content">
      <div class="btn-group" style="float: right; font-size: small; padding: 6px;  ">
       <button type="button" class="btn btn-xs btn-default" onclick="window.location.href=&quot;https://github.com/incodehq/incode-platform/edit/master/adocs/documentation/src/main/asciidoc/modules/lib/minio/lib-minio.adoc&quot;"><i class="fa fa-pencil-square-o"></i>&nbsp;Edit</button>
       <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span><span class="sr-only">Toggle Dropdown</span></button>
       <ul class="dropdown-menu">
        <li><a href="https://github.com/incodehq/incode-platform/edit/master/adocs/documentation/src/main/asciidoc/modules/lib/minio/lib-minio.adoc" target="_blank"><i class="fa fa-pencil-square-o fa-fw" aria-hidden="true"></i>&nbsp; Edit</a></li>
        <li><a href="https://github.com/incodehq/incode-platform/commits/master/adocs/documentation/src/main/asciidoc/modules/lib/minio/lib-minio.adoc" target="_blank"><i class="fa fa-clock-o fa-fw" aria-hidden="true"></i>&nbsp; History</a></li>
        <li><a href="https://github.com/incodehq/incode-platform/raw/master/adocs/documentation/src/main/asciidoc/modules/lib/minio/lib-minio.adoc" target="_blank"><i class="fa fa-file-text-o fa-fw" aria-hidden="true"></i>&nbsp; Raw</a></li>
        <li><a href="https://github.com/incodehq/incode-platform/blame/master/adocs/documentation/src/main/asciidoc/modules/lib/minio/lib-minio.adoc" target="_blank"><i class="fa fa-hand-o-right fa-fw" aria-hidden="true"></i>&nbsp; Blame</a></li>
       </ul>
      </div> 
      <div id="preamble"> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>This module (<code>incode-module-minio-dom</code>) and its various submodules provides a libray for archiving BLOBs from a domain entity and persisting them instead using <a href="https://www.minio.io/">Minio</a>.</p> 
        </div> 
        <div class="paragraph"> 
         <p>The idea is that domain entities such as documents, that large blob/clob content initially persist that content "in-line". At some later point, that content is copied from the domain entity into Minio, and then that content is removed. In its place the URL of the content as persisted in Minio is stored as a pointer.</p> 
        </div> 
        <div class="paragraph"> 
         <p>Most of the functionality provided by this module is intended to be used by an integration solution - such as Apache Camel - rather than an Apache Isis domain application, and can be used "as-is".</p> 
        </div> 
        <div class="paragraph"> 
         <p>The module also provides an SPI for the Apache Isis domain app to implement, acting as a bridge to the specifics of the domain app and the entities it may require archiving.</p> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_architecture">Architecture</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>The diagram below sketches the components provided by this module, and how they interact:</p> 
        </div> 
        <div class="imageblock"> 
         <div class="content"> 
          <a class="image" href="images//design-sketch.png"><img src="images//design-sketch.png" alt="design sketch" width="800px"></a> 
         </div> 
        </div> 
        <div class="paragraph"> 
         <p>The central algorithm is implemented by <code>MinioArchiver</code> (in the <code>incode-module-minio-minioarchlib</code> submodule). This:</p> 
        </div> 
        <div class="ulist"> 
         <ul> 
          <li> <p>calls <code>DocBlobClient</code> to obtain a list of all documents that need to be archived.</p> 
           <div class="paragraph"> 
            <p>The <code>DocBlobClient</code> is the <code>incode-module-minio-docclient</code> submodule.</p> 
           </div> </li> 
          <li> <p>The <code>DocBlobClient</code> in turn makes a REST call to <code>DocBlobService</code>, hosted by the Apache Isis webapp.</p> 
           <div class="paragraph"> 
            <p>The <code>DocBlobService</code> is in the <code>incode-module-minio-docserver</code> submodule, and so this is the one dependency that an Apache Isis webapp has on the Minio library.</p> 
           </div> </li> 
          <li> <p>within the Apache Isis webapp, the <code>DocBlobService</code> delegates to the <code>DocBlobServiceBridge</code>.</p> 
           <div class="paragraph"> 
            <p>This is an SPI that the consuming application is required to implement. Typically this is likely to delegate to some repository service to obtain entity/ies that have blobs, eg documents.</p> 
           </div> </li> 
          <li> <p>for each of the returned blobs, the <code>MinioArchiver</code> then calls the <code>MinioBlobClient</code> to upload the blob into Minio itself. This returns back a URL.</p> 
           <div class="paragraph"> 
            <p>The <code>MinioBlobClient</code> is in the <code>incode-module-minio-minioclient</code> submodule.</p> 
           </div> </li> 
          <li> <p>for each blob and its corresponding URI, the <code>MinioArchiver</code> then calls the <code>DocBlobClient</code> once more, this time to indicate that the blob has been archived.</p> </li> 
          <li> <p>the <code>DocBlobClient</code> in turn again makes a REST call up to <code>DocBlobService</code>, hosted on the Apache Isis webapp.</p> </li> 
          <li> <p>once more the <code>DocBlobService</code> delegates to the <code>DocBlobServiceBridge</code> SPI.</p> 
           <div class="paragraph"> 
            <p>The implementation of this (provided by the consuming application) will typically delete the blob from the original entity, and in its place store the URI as a pointer to Minio.</p> 
           </div> 
           <div class="admonitionblock note"> 
            <table> 
             <tbody>
              <tr> 
               <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> 
               <td class="content"> 
                <div class="paragraph"> 
                 <p>It’s the responsibility of the consuming application to download the content from Minio (using the URL); this library does not (currently) provide any utility services for this.</p> 
                </div> </td> 
              </tr> 
             </tbody>
            </table> 
           </div> </li> 
         </ul> 
        </div> 
        <div class="paragraph"> 
         <p>The <code>MinioArchiver</code> described above is packaged as a library, so will typically be called periodically from some sort of integration solution. As the diagram above suggests, this could be accompllished using Apache Camel, whereby a <code>MinioArchiverProcessor</code> (not part of this library) acts as a simple wrapper that calls the <code>MinioArchiver</code>. That processer in turn might be scheduled to run periodically, say once an hour.</p> 
        </div> 
        <div class="paragraph"> 
         <p>When first deploying this solution, there will probably be a need to archive historical blobs. The <code>Main</code> utility in the <code>incode-module-minio-minioarchtool</code> is a standalone utility that simply calls the <code>MinioArchiver</code> to archive all.</p> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="__lib-minio_url-format">URL format</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>The format of the URLs created by `MinioBlobClient is:</p> 
        </div> 
        <div class="paragraph"> 
         <p><code><a href="http://minioserver/prod/myapp/cust.Customer/1234" class="bare">http://minioserver/prod/myapp/cust.Customer/1234</a></code></p> 
        </div> 
        <div class="paragraph"> 
         <p>where:</p> 
        </div> 
        <div class="ulist"> 
         <ul> 
          <li> <p>"http://minioserver" is the base URL which hosts the server</p> </li> 
          <li> <p>"prod" is the S3 bucket to use; typically this represents an environment such as dev, test or production</p> </li> 
          <li> <p>"myapp" is a fixed prefix. This represents the original app from which the Blob was obtained, and therefore how to interpret the remainder of the URL</p> </li> 
          <li> <p>"cust.Customer/1234" is the identifier of (in this case) a customer. It corresponds to the bookmark of the Apache Isis application (having replaced '/' with ':').</p> </li> 
         </ul> 
        </div> 
        <div class="admonitionblock note"> 
         <table> 
          <tbody>
           <tr> 
            <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> 
            <td class="content"> 
             <div class="paragraph"> 
              <p>The above scheme means that only one blob can be persisted per object instance. A future enhancement would be to allow multiple blobs to be persisted (corresponding to different properties of the original entity in the Apache Isis webapp).</p> 
             </div> </td> 
           </tr> 
          </tbody>
         </table> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_integration_solution_eg_apache_camel">Integration solution (eg Apache Camel)</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>This section describes how to configure and use the minio library within the integration solution (eg Apache Camel), ie that periodically invokes the <code>MinioArchiver</code>.</p> 
        </div> 
        <div class="sect2"> 
         <h3 id="_classpath">Classpath</h3> 
         <div class="paragraph"> 
          <p>Update your classpath by adding these dependencies to your <code>pom.xml</code>:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.incode.module.minio<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>incode-module-minio-minioclient<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.incode.module.minio<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>incode-module-minio-archlib<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.incode.module.minio<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>incode-module-minio-docclient<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>Check for later releases by searching <a href="http://search.maven.org/#search|ga|1|incode-module-minio-minioarchlib">Maven Central Repo</a>.</p> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_apache_camel_example_processor">Apache Camel Example Processor</h3> 
         <div class="paragraph"> 
          <p>If using Apache Camel as the integration solution, then the code below can be used as a basis for a processor:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.apache.camel.Exchange</span>;
<span class="keyword">import</span> <span class="include">org.apache.camel.Processor</span>;
<span class="keyword">import</span> <span class="include">org.incode.module.minio.minioarchlib.MinioArchiver</span>;
<span class="keyword">import</span> <span class="include">lombok.Setter</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MinioArchiverProcessor</span> <span class="directive">implements</span> Processor {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MAX_ITERATIONS = <span class="integer">5</span>;

    <span class="annotation">@Setter</span>
    <span class="directive">private</span> MinioArchiver minioArchiver;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> process(<span class="directive">final</span> Exchange exchange) {

        <span class="keyword">try</span> {
            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; MAX_ITERATIONS; i++) {
                <span class="type">int</span> numArchived = minioArchiver.archive(<span class="string"><span class="delimiter">"</span><span class="content">camel</span><span class="delimiter">"</span></span>);
                LOG.info(numArchived + <span class="string"><span class="delimiter">"</span><span class="content"> archived</span><span class="delimiter">"</span></span>);
                <span class="keyword">if</span> (numArchived == <span class="integer">0</span>) {
                    <span class="keyword">break</span>;
                }
            }
        } <span class="keyword">catch</span>(<span class="predefined-type">Throwable</span> ex) {
            LOG.error(ex.getMessage());
        }
    }
}</code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>This invokes the <code>MinioArchiver</code> up to 5 times. The idea here is to allow the archiving to be performed in batches, avoiding very large database updates during initial migration of blobs from the Apache Isis webapp and into Minio.</p> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_apache_camel_spring_based_config">Apache Camel Spring-based config</h3> 
         <div class="paragraph"> 
          <p>If running inside of Apache Camel and using Spring to configure the components:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">"</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">"</span></span>
       <span class="attribute-name">xmlns:camel</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://camel.apache.org/schema/spring</span><span class="delimiter">"</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">"</span> <span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span> <span class="content">http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioArchiverProcessor</span><span class="delimiter">"</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">org.incode.ecp.est2minio.route.MinioArchiverProcessor</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioArchiver</span><span class="delimiter">"</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioArchiver</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioArchiver</span><span class="delimiter">"</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">org.incode.module.minio.minioarchlib.MinioArchiver</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">docBlobClient</span><span class="delimiter">"</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">docBlobClient</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioBlobClient</span><span class="delimiter">"</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioBlobClient</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioBlobClient</span><span class="delimiter">"</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">org.incode.module.minio.minioclient.MinioBlobClient</span><span class="delimiter">"</span></span>
          <span class="attribute-name">init-method</span>=<span class="string"><span class="delimiter">"</span><span class="content">init</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">url</span><span class="delimiter">"</span></span>       <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">"</span><span class="content">${minio.baseUrl}</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">accessKey</span><span class="delimiter">"</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">"</span><span class="content">${minio.accessKey}</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">secretKey</span><span class="delimiter">"</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">"</span><span class="content">${minio.secretKey}</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">bucket</span><span class="delimiter">"</span></span>    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">"</span><span class="content">${minio.bucket}</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">prefix</span><span class="delimiter">"</span></span>    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">"</span><span class="content">${minio.prefix}</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">docBlobClient</span><span class="delimiter">"</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">"</span><span class="content">org.incode.module.minio.docclient.DocBlobClient</span><span class="delimiter">"</span></span>
          <span class="attribute-name">init-method</span>=<span class="string"><span class="delimiter">"</span><span class="content">init</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">base</span><span class="delimiter">"</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">"</span><span class="content">${apacheIsisWebapp.baseUrl}</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">username</span><span class="delimiter">"</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">"</span><span class="content">${apacheIsisWebapp.username}</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">password</span><span class="delimiter">"</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">"</span><span class="content">${apacheIsisWebapp.password}</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>This requires the following configuration properties to be defined:</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p><code>minio.baseUrl</code> - base URL for minio server (to upload to)</p> </li> 
           <li> <p><code>minio.accessKey</code> - user account to access minio</p> </li> 
           <li> <p><code>minio.secretKey</code> - corresponding password for the minio user account</p> </li> 
           <li> <p><code>minio.bucket</code> - as explained in the <a href="#__lib-minio_url-format">above section</a> on the URL format, typically indicates the "environment"</p> </li> 
           <li> <p><code>minio.prefix</code> - as explained in the <a href="#__lib-minio_url-format">above section</a> on the URL format, typically indicates the source of the blob</p> </li> 
           <li> <p><code>apacheIsisWebapp.baseUrl</code> - base URL for the Apache Isis webapp (to read blobs from)</p> </li> 
           <li> <p><code>apacheIsisWebapp.username</code> - user account to access Apache Isis webapp</p> </li> 
           <li> <p><code>apacheIsisWebapp.password</code> - corresponding password for the Apache Isis webapp</p> </li> 
          </ul> 
         </div> 
         <div class="paragraph"> 
          <p>The Camel route that invokes the <code>MinioArchiverProcessor</code> (in the same file) is defined as:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
    ...

    <span class="tag">&lt;camelContext</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://camel.apache.org/schema/spring</span><span class="delimiter">"</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">minio</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;route</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioFromQuartz</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;from</span> <span class="attribute-name">uri</span>=<span class="string"><span class="delimiter">"</span><span class="content">quartz://camel/estatioToMinio?cron=30+*+7-18+?+*+MON-FRI</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;camel:process</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">minioArchiverProcessor</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/route&gt;</span>
    <span class="tag">&lt;/camelContext&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>Here the configuration for the <code>quartz</code> source is to run once an hour, from 7am to 6pm:</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p><code>30</code> - seconds: at 30 seconds past the minute only</p> </li> 
           <li> <p><code>*</code> - minutes: every minute</p> </li> 
           <li> <p><code>7-18</code> - hours: from 7 til 18. First three parts imply therefore running every minute, 7:00 to 18:00</p> </li> 
           <li> <p><code>?</code> - day-of-month: omit, because cannot specify both this and also day-of-week (below)</p> </li> 
           <li> <p><code>*</code> - month-of-year: every month of the year</p> </li> 
           <li> <p><code>MON-FRI</code> - day-of-week: only mondays to fridays</p> </li> 
          </ul> 
         </div> 
         <div class="admonitionblock note"> 
          <table> 
           <tbody>
            <tr> 
             <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> 
             <td class="content"> 
              <div class="paragraph"> 
               <p>'+' separates the parts (same as URL encoding a space)</p> 
              </div> </td> 
            </tr> 
           </tbody>
          </table> 
         </div> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_apache_isis_application">Apache Isis application</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>This section describes the responsibilities of the Apache Isis webapp that has domain entities with blobs that are to be archived.</p> 
        </div> 
        <div class="sect2"> 
         <h3 id="_spi">SPI</h3> 
         <div class="paragraph"> 
          <p>The consuming Apache Isis application is required to implement the <code>DocBlobServiceBridge</code> SPI:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="title">
           DocBlobServiceBridge.java
          </div> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">DocBlobServiceBridge</span> {

    <span class="annotation">@Programmatic</span>
    <span class="predefined-type">List</span>&lt;DocBlob&gt; findToArchive(<span class="predefined-type">String</span> caller);

    <span class="annotation">@Programmatic</span>
    <span class="predefined-type">Blob</span> blobFor(DocBlob docBlob);

    <span class="annotation">@Programmatic</span>
    <span class="type">void</span> archive(<span class="predefined-type">String</span> docBookmark, <span class="predefined-type">String</span> externalUrl);
}</code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>where <code>DocBlob</code> is a view model that in effect just wraps the identity of the source entity which holds the blob:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="title">
           DocBlob.java
          </div> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@DomainObject</span>(
        nature = Nature.VIEW_MODEL,
        objectType = <span class="string"><span class="delimiter">"</span><span class="content">incodeMinio.DocBlob</span><span class="delimiter">"</span></span>
)
<span class="directive">public</span> <span class="type">class</span> <span class="class">DocBlob</span> <span class="directive">implements</span> ViewModel {

    <span class="directive">public</span> DocBlob(<span class="directive">final</span> <span class="predefined-type">String</span> docBookmark) {
        <span class="local-variable">this</span>.docBookmark = docBookmark;
    }

    <span class="annotation">@Getter</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> docBookmark;     <i class="conum" data-value="1"></i><b>(1)</b>

    ...
}</code></pre> 
          </div> 
         </div> 
         <div class="colist arabic"> 
          <table> 
           <tbody>
            <tr> 
             <td><i class="conum" data-value="1"></i><b>1</b></td> 
             <td>Bookmark of the persisted entity which holds the blob to be archived (or may have been archived).</td> 
            </tr> 
           </tbody>
          </table> 
         </div> 
         <div class="paragraph"> 
          <p>In the implementation of this SPI, the application can create <code>DocBlob</code> instances simply using the regular <code>BookmarkService</code>:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> Bookmark bookmark = bookmarkService.bookmarkFor(entity);
<span class="keyword">return</span> <span class="keyword">new</span> DocBlob(bookmark.toString());</code></pre> 
          </div> 
         </div> 
         <div class="admonitionblock note"> 
          <table> 
           <tbody>
            <tr> 
             <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> 
             <td class="content"> 
              <div class="paragraph"> 
               <p>The <code>DocBlobServiceBridge</code> SPI is slightly inconsistent; the <code>archive(…​)</code> method ought to take a <code>DocBlob</code> rather than a <code>docBookmark</code>.</p> 
              </div> </td> 
            </tr> 
           </tbody>
          </table> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_classpath_2">Classpath</h3> 
         <div class="paragraph"> 
          <p>Update your classpath by adding these dependencies to your <code>pom.xml</code>:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.incode.module.minio<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>incode-module-minio-docserver<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>Check for later releases by searching <a href="http://search.maven.org/#search|ga|1|incode-module-minio-docserver">Maven Central Repo</a>.</p> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_bootstrapping">Bootstrapping</h3> 
         <div class="paragraph"> 
          <p>The SPI service implementation must be included in the application bootstrapping. Typically this is done by defining an owning <code>Module</code> and then including that module in the application’s <code>AppManifest</code>.</p> 
         </div> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_known_issues_limitations">Known issues / Limitations</h2> 
       <div class="sectionbody"> 
        <div class="ulist"> 
         <ul> 
          <li> <p>This implementation only supports one blob/clob property per domain type.</p> </li> 
          <li> <p>It also doesn’t distinguish between different domain types which may require archiving. This makes it the responsibility of the SPI to "assemble" the lists of all domain entities which may require archival (eg <code>Document</code>s, <code>Command</code>s, <code>PublishedEvent</code>s) rather than each being archived separately.</p> </li> 
          <li> <p>The library also doesn’t provide any support for the consuming application to retrieving blobs from Minio. This is accomplished easily enough though, eg:</p> 
           <div class="listingblock"> 
            <div class="content"> 
             <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> <span class="predefined-type">String</span> minioUrl = ...

final <span class="predefined-type">URL</span> url = <span class="keyword">new</span> <span class="predefined-type">URL</span>(minioUrl);

<span class="directive">final</span> <span class="predefined-type">HttpURLConnection</span> httpConn = openConnection(url);
<span class="keyword">if</span> (httpConn == <span class="predefined-constant">null</span>) {
    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}

<span class="directive">final</span> <span class="predefined-type">String</span> contentType = httpConn.getContentType();

<span class="directive">final</span> MimeType mimeType = determineMimeType(contentType);
<span class="keyword">if</span> (mimeType == <span class="predefined-constant">null</span>) {
    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}

httpConn.disconnect();

<span class="directive">final</span> ByteSource byteSource = Resources.asByteSource(url);
<span class="directive">final</span> <span class="type">byte</span><span class="type">[]</span> bytes = byteSource.read();

<span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Blob</span>(document.getName(), mimeType.getBaseType(), bytes);</code></pre> 
            </div> 
           </div> </li> 
         </ul> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_dependencies">Dependencies</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>For the Apache Isis webapp, this library has no dependencies.</p> 
        </div> 
       </div> 
      </div> 
     </div> 
    </div> 
    <div class="hidden-xs hidden-sm hidden-md col-lg-3"> 
     <nav id="toc" data-spy="affix" data-toggle="toc"></nav> 
    </div> 
   </div> 
  </div> 
  <footer class="footer"> 
   <div class="container"> 
    <div class="row"> 
     <p class="text-center small text-muted"> Copyright © 2012~date Dan Haywood, licensed under the Apache&nbsp;License,&nbsp;v2.0. </p> 
    </div> 
   </div> 
  </footer> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> 
  <script src="../../../js/bootstrap/3.3.7/bootstrap.min.js"></script> 
  <script src="../../../js/bootstrap-toc/0.4.1/bootstrap-toc.min.js"></script> 
  <script src="../../../js/slick/1.5.0/slick.min.js"></script> 
  <script src="../../../js/elasticlunr/elasticlunr.min.js"></script> 
  <script src="../../../js/sticky-header/sticky-header.js"></script> 
  <script src="../../../js/search-panel/search-panel.js"></script> 
  <script src="../../../js/header-link/header-link.js"></script> 
  <script src="../../../js/toc-scroll/toc-scroll.js"></script>  
 </body>
</html>
