<!doctype html>
<html>
 <head> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <!-- No caching headers --> 
  <meta http-equiv="cache-control" content="no-cache"> 
  <meta http-equiv="pragma" content="no-cache"> 
  <meta http-equiv="expires" content="-1"> 
  <title>Command Replay</title> 
  <link rel="icon" type="image/png" href="../../../images/incode-favicon.png"> 
  <!--
        Based on DataNucleus' template,
        that was in turn based on an earlier version of Apache Isis' template,
        that was in turn based on Apache Deltaspike's template.

        This template uses
        * Bootstrap v3.3.7 (https://getbootstrap.com/) for navbar.
        * Bootstrap TOC plugin v0.4.1 (https://afeld.github.io/bootstrap-toc/)
          for the table of contents.
        * jQuery (necessary for Bootstrap's JavaScript plugins)
        * Font-Awesome for some icons used by Asciidoctor

        Also:
        * Bootswatch "flatly" theme for Bootstrap (https://bootswatch.com/flatly).
        * slick.js (carousel)
        * add a link to all headers (home-grown, adapted from blog posts)
        * integration of elasticlunr.js (home-grown, adapted from blog posts)
    --> 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"> 
  <link href="../../../css/bootstrap-toc/0.4.1/bootstrap-toc.min.css" rel="stylesheet"> 
  <link href="../../../css/asciidoctor/foundation.css" rel="stylesheet"> 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet"> 
  <link href="../../../css/slick/1.5.0/slick.css" rel="stylesheet"> 
  <link href="../../../css/slick/1.5.0/slick-theme.css" rel="stylesheet"> 
  <link href="../../../css/search-panel/search-panel.css" rel="stylesheet"> 
  <link href="../../../css/header-links/header-links.css" rel="stylesheet"> 
  <link href="../../../css/sticky-header/sticky-header.css" rel="stylesheet"> 
  <link href="../../../css/customisations.css" rel="stylesheet"> 
  <!-- Coderay syntax formatter --> 
  <style type="text/css">
        /* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
    </style> 
 </head> 
 <body data-spy="scroll" data-target="#toc"> 
  <div id="basedir" style="display:none;">
   ../../../
  </div> 
  <div id="docname" style="display:none;">
   spi-command-replay
  </div> 
  <div id="filetype" style="display:none;">
   html
  </div> 
  <!-- Navbar --> 
  <nav class="navbar navbar-default navbar-static-top header"> 
   <div class="container"> 
    <div class="navbar-header"> 
     <!-- Three line menu button for use on mobile screens --> 
     <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> 
     <a class="navbar-brand" href="../../../index.html"> <img alt="Brand" src="../../../images/incode-logo-66x52.png"> </a> 
     <a class="navbar-brand" href="../../../index.html">Incode Platform</a> 
    </div> 
    <!-- Navbar that will collapse on mobile screens --> 
    <div id="navbar" class="navbar-collapse collapse"> 
     <ul class="nav navbar-nav"> 
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Quickstart<span class="caret"></span></a> 
       <ul class="dropdown-menu"> 
        <li><a href="../../../quickstart/quickstart.html">Quickstart App</a></li> 
       </ul> </li> 
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Modules<span class="caret"></span></a> 
       <ul class="dropdown-menu"> 
        <li><a href="../../../modules/incode-parent.html">Parent POM</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">Modules</li> 
        <li><a href="../../../modules/lib/lib.html">Libraries</a></li> 
        <li><a href="../../../modules/spi/spi.html">SPI Implementations</a></li> 
        <li><a href="../../../modules/wkt/wkt.html">Wicket Components</a></li> 
        <li><a href="../../../modules/mml/mml.html">MetaModel Facets</a></li> 
        <li><a href="../../../modules/ext/ext.html">Extensions</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">Examples</li> 
        <li><a href="../../../modules/dom/dom.html">Example Subdomains</a></li> 
       </ul> </li> 
      <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Support<span class="caret"></span></a> 
       <ul class="dropdown-menu"> 
        <li class="dropdown-header">Source code</li> 
        <li><a href="https://github.com/incodehq/incode-platform">Github</a></li> 
        <li><a href="https://github.com/incodehq/incode-platform/issues">Issue Tracker</a></li> 
        <li><a href="../../../pages/change-log/change-log.html">Change Log</a></li> 
        <li role="separator" class="divider"></li> 
        <li class="dropdown-header">Guides</li> 
        <li><a href="../../../pages/contributors-guide/contributors-guide.html">Contributors guide</a></li> 
        <li><a href="../../../pages/committers-guide/committers-guide.html">Committers guide</a></li> 
        <li role="separator" class="divider"></li> 
        <li><a href="../../../pages/license.html">License</a></li> 
        <li><a href="../../../pages/thanks.html">Thanks</a></li> 
       </ul> </li> 
     </ul> 
     <div class="nav navbar-nav navbar-right"> 
      <!-- 'style' added to fix height of input box. FIX THIS --> 
      <form class="navbar-form" role="search" id="search-form" style="padding: 1px 15px;"> 
       <div class="form-group"> 
        <input class="form-control" id="search-field" type="text" size="30" placeholder="Search"> 
       </div> 
      </form> 
     </div> 
    </div> 
   </div> 
  </nav> 
  <div class="container"> 
   <div class="row-fluid"> 
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-9"> 
     <div id="search-panel"> 
      <div id="search-results"></div> 
      <div> 
       <br> 
       <a href="#" id="search-results-clear">clear</a> 
      </div> 
     </div> 
     <span class="pdf-link"><a href="spi-command-replay.pdf"><img src="../../../images/PDF-50.png"></a></span> 
     <div class="page-title"> 
      <h1>Command Replay</h1> 
     </div> 
     <div id="doc-content">
      <div class="btn-group" style="float: right; font-size: small; padding: 6px;  ">
       <button type="button" class="btn btn-xs btn-default" onclick="window.location.href=&quot;https://github.com/incodehq/incode-platform/edit/master/adocs/documentation/src/main/asciidoc/modules/spi/command/spi-command-replay.adoc&quot;"><i class="fa fa-pencil-square-o"></i>&nbsp;Edit</button>
       <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span><span class="sr-only">Toggle Dropdown</span></button>
       <ul class="dropdown-menu">
        <li><a href="https://github.com/incodehq/incode-platform/edit/master/adocs/documentation/src/main/asciidoc/modules/spi/command/spi-command-replay.adoc" target="_blank"><i class="fa fa-pencil-square-o fa-fw" aria-hidden="true"></i>&nbsp; Edit</a></li>
        <li><a href="https://github.com/incodehq/incode-platform/commits/master/adocs/documentation/src/main/asciidoc/modules/spi/command/spi-command-replay.adoc" target="_blank"><i class="fa fa-clock-o fa-fw" aria-hidden="true"></i>&nbsp; History</a></li>
        <li><a href="https://github.com/incodehq/incode-platform/raw/master/adocs/documentation/src/main/asciidoc/modules/spi/command/spi-command-replay.adoc" target="_blank"><i class="fa fa-file-text-o fa-fw" aria-hidden="true"></i>&nbsp; Raw</a></li>
        <li><a href="https://github.com/incodehq/incode-platform/blame/master/adocs/documentation/src/main/asciidoc/modules/spi/command/spi-command-replay.adoc" target="_blank"><i class="fa fa-hand-o-right fa-fw" aria-hidden="true"></i>&nbsp; Blame</a></li>
       </ul>
      </div> 
      <div id="preamble"> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>The "replay" library (introduced in <code>1.16.1</code>) allows commands on a <em>master</em> server to be replayed against a <em>slave</em> server.</p> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_typical_use_case">Typical use case</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>One use case for this is for regression testing or A/B testing of two different versions of an application (eg after a system upgrade, or after a refactoring of business logic).</p> 
        </div> 
        <div class="paragraph"> 
         <p>The <em>master</em> and <em>slave</em> are set up in a test environment with the <em>master</em> pointing at a database backup a few days in the future from the <em>slave</em>. For example, the <em>master</em> database could be restored with a copy of Wednesday night backup, while the <em>slave</em> could be restored with a copy of Monday night’s backup. Master is therefore two days "ahead" of the <em>slave</em>.</p> 
        </div> 
        <div class="paragraph"> 
         <p>The <em>master</em> instance is just a regular instance of the application, but the <em>slave</em> instance is started with a number of additional configuration parameters. These are used to allow the <em>slave</em> to copy commands from the <em>master</em> using the REST API, and then to execute them (similar to the way that background commands are executed).</p> 
        </div> 
        <div class="paragraph"> 
         <p>An alternative configuration is to use production instance as <em>master</em>, with the <em>slave</em> being in the test environment. The <em>slave</em> instance would be restored from the previous night’s database backup. As the online users make changes to the production (<em>master</em>), these are applied to the <em>slave</em> also.</p> 
        </div> 
        <div class="paragraph"> 
         <p>Obviously using production as <em>master</em> introduces additional load: the <em>slave</em> continually polls the <em>master</em> for new commands and so there will be additional load that should be taken into account.</p> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_design">Design</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>The replication of <code>Command</code>s from <em>master</em> is <em>slave</em> is based on the idea of a "high water mark" (HWM). This represents the most recently executed command on the <em>slave</em>. The algorithm is as follows:</p> 
        </div> 
        <div class="ulist"> 
         <ul> 
          <li> <p>the <em>slave</em> polls the <em>master</em> for the "next" <strong>foreground</strong> command after its HWM (by timestamp);</p> </li> 
          <li> <p>if there is one then this is copied over the <em>slave</em> and persisted, at which point it becomes the new HWM;</p> </li> 
          <li> <p>the command is then executed, and any background commands that might have been created as a result of this are also executed immediately.</p> </li> 
         </ul> 
        </div> 
        <div class="paragraph"> 
         <p>Note that background commands are never replicated. When the replicated foreground command is executed, it will create its own background commands on the <em>slave</em> and these are what are executed.</p> 
        </div> 
        <div class="paragraph"> 
         <p>If the command was replayed successfully then the <em>slave</em> loops around looking for the next command, continuing until all commands have been copied over from <em>master</em> to <em>slave</em>, one by one.</p> 
        </div> 
        <div class="paragraph"> 
         <p>But, if the command failed to replay, then the <em>slave</em> stops until the issue is resolved. More on this topic below.</p> 
        </div> 
        <div class="sect2"> 
         <h3 id="__patching_mementos">"Patching" Mementos</h3> 
         <div class="paragraph"> 
          <p>On <em>master</em> the persisted commands (that is, <code>CommandJdo</code> entity instances) hold an XML memento that is a serialization of <code>CommandDto</code> (as per the <a href="../rgcms/rgcms.html#<em>rgcms_schema-cmd.adoc"><code>cmd.xsd</code></a> schema). This serializes the state of values and of entity references automatically. However, for space reasons it does _not serialize any <code>Blob</code> or <code>Clob</code> arguments; the values are simply missing in the XML.</p> 
         </div> 
         <div class="paragraph"> 
          <p>To address this a <code>CommandDtoProcessor</code> implementation can be specified on a case-by-case basis. This interface is defined as:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CommandDtoProcessor</span> {
    CommandDto process(<span class="directive">final</span> Command command, CommandDto commandDto);
}</code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>This is specified using the <a href="../rgant/rgant.html#_rgant-Action_commandDtoProcessor"><code>@Action#commandDtoProcessor()</code></a> or <a href="../rgant/rgant.html#_rgant-Property_commandDtoProcessor"><code>@Property#commandDtoProcessor()</code></a> attribute. For example:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Action</span>(domainEvent = IncomingDocumentRepository.UploadDomainEvent.class,
            commandDtoProcessor = DeriveBlobFromReturnedDocumentArg0.class
    )
    <span class="annotation">@MemberOrder</span>(sequence = <span class="string"><span class="delimiter">"</span><span class="content">3</span><span class="delimiter">"</span></span>)
    <span class="directive">public</span> <span class="predefined-type">Document</span> upload(<span class="directive">final</span> <span class="predefined-type">Blob</span> blob) {
        <span class="directive">final</span> <span class="predefined-type">String</span> name = blob.getName();
        <span class="directive">final</span> DocumentType type = DocumentTypeData.INCOMING.findUsing(documentTypeRepository);
        <span class="directive">final</span> ApplicationUser me = meService.me();
        <span class="predefined-type">String</span> atPath = me != <span class="predefined-constant">null</span> ? me.getAtPath() : <span class="predefined-constant">null</span>;
        <span class="keyword">if</span> (atPath == <span class="predefined-constant">null</span>) {
            atPath = <span class="string"><span class="delimiter">"</span><span class="content">/</span><span class="delimiter">"</span></span>;
        }
        <span class="keyword">return</span> incomingDocumentRepository.upsertAndArchive(type, atPath, name, blob);
    }</code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>where <code>DeriveBlobFromReturnedDocumentArg0</code> (simplified) is:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DeriveBlobFromReturnedDocumentArg0</span>
        <span class="directive">extends</span> DeriveBlobFromReturnedDocumentAbstract {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> CommandDto process(
            <span class="directive">final</span> Command command,
            <span class="directive">final</span> CommandDto commandDto) {
        <span class="directive">final</span> Bookmark result = command.getResult();
        <span class="keyword">if</span>(result == <span class="predefined-constant">null</span>) <span class="keyword">return</span> commandDto;
        <span class="directive">final</span> <span class="predefined-type">Document</span> document = bookmarkService.lookup(result, <span class="predefined-type">Document</span>.class);
        <span class="keyword">if</span> (document != <span class="predefined-constant">null</span>) {
            ParamDto paramDto = getParamDto(commandDto, <span class="integer">0</span>);
            CommonDtoUtils.setValueOn(
                paramDto, ValueType.BLOB, document.getBlob(), bookmarkService);
        }
        <span class="keyword">return</span> commandDto;
    }
    <span class="annotation">@Inject</span>
    BookmarkService bookmarkService;
}</code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>So, in effect, the <code>CommandDtoProcessor</code> allows the <code>CommandDto</code> to be "patched" with the missing information that was not persisted in the XML. This missing information <em>does</em> end up being persisted in the command’s memento on the <em>slave</em>, but is not persisted in the <em>master</em>.</p> 
         </div> 
         <div class="paragraph"> 
          <p>If the <code>CommandDtoProcessor</code> returns null, then the <code>Command</code> is effectively excluded from the result set, and so is not replicated. The <code>CommandDtoProcessor.Null</code> class is such an implementation. For example:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Action</span>(
        commandDtoProcessor = CommandDtoProcessor.Null.class
)
<span class="directive">public</span> TurnoverImportManager uploadSpreadsheet(
        <span class="annotation">@Parameter</span>(fileAccept = <span class="string"><span class="delimiter">"</span><span class="content">.xlsx</span><span class="delimiter">"</span></span>)
        <span class="directive">final</span> <span class="predefined-type">Blob</span> spreadsheet) {
    ...
}</code></pre> 
          </div> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_defining_failures">Defining Failures</h3> 
         <div class="paragraph"> 
          <p>A "replay failure" does not necessarily mean that executing the command threw an exception; it could be the case that the command also threw an exception on the <em>master</em>. In such a case, "replay success" means that the same exception was thrown.</p> 
         </div> 
         <div class="paragraph"> 
          <p>So instead, for flexibility, there is a pluggable SPI that allows "command replay analysers" to be installed. If any such analyser detects an error, then the command replay is marked as failed and replication ceases.</p> 
         </div> 
         <div class="paragraph"> 
          <p>This SPI is defined as:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CommandReplayAnalyser</span> {
    <span class="predefined-type">String</span> analyzeReplay(
            <span class="directive">final</span> Command command,      <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="directive">final</span> CommandDto dto);      <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre> 
          </div> 
         </div> 
         <div class="colist arabic"> 
          <table> 
           <tbody>
            <tr> 
             <td><i class="conum" data-value="1"></i><b>1</b></td> 
             <td>The <code>Command</code> that has just been executed. This will have its <code>startedAt</code>, <code>completedAt</code> properties set, and either a <code>result</code> (unless void) or an <code>exception</code> (if any occurred).</td> 
            </tr> 
            <tr> 
             <td><i class="conum" data-value="2"></i><b>2</b></td> 
             <td>The DTO obtained from the <code>Command</code>, being the memento copied over from the <em>master</em>. This is passed in as a small performance optimisation to save each analyser having to unmarshal the DTO from XML.</td> 
            </tr> 
           </tbody>
          </table> 
         </div> 
         <div class="paragraph"> 
          <p>The command replay module provides a number of pre-built implementations.</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p><code>CommandReplayAnalyserResultStr</code></p> 
            <div class="paragraph"> 
             <p>If both <em>master</em> and <em>slave</em> produces a result, then checks they are the same</p> 
            </div> </li> 
           <li> <p><code>CommandReplayAnalyserExceptionStr</code></p> 
            <div class="paragraph"> 
             <p>If both <em>master</em> and <em>slave</em> produces an exception, then checks that the first 500 characters of that exception’s stack trace are the same.</p> 
            </div> </li> 
           <li> <p><code>CommandReplayAnalyserNumberBackgroundCommands</code></p> 
            <div class="paragraph"> 
             <p>Checks that the number of background commands created by both <em>master</em> and <em>slave</em> are the same.</p> 
            </div> </li> 
          </ul> 
         </div> 
         <div class="paragraph"> 
          <p>All of these in-built implementations can be disabled, by setting the appropriate configuration option. For example, to disable the ResultStr analyser, add:</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p><code>isis.services.CommandReplayAnalyserResultStr.analysis=disabled</code></p> </li> 
          </ul> 
         </div> 
         <div class="paragraph"> 
          <p>Similarly for the other analysers.</p> 
         </div> 
         <div class="paragraph"> 
          <p>New implementations of this SPI can be also registered simply by annotating as a domain service within a module loaded by the application’s manifest.</p> 
         </div> 
         <div class="paragraph"> 
          <p>To facilitate this the replay module also defines a more general SPI, called <code>CommandDtoProcessorService</code>. This is almost identical to the <code>CommandDtoProcessor</code> (which is defined on an action-by-action basis), except it runs for all commands:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CommandDtoProcessorService</span> {
    CommandDto process(Command command, CommandDto commandDto);
}</code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>This can therefore be used to capture additional information within the memento on the <em>master</em>, and then have the replay analyser on the <em>slave</em> check. In fact, the same service implementation can implement both the <code>CommandDtoProcessorService</code> and <code>CommandReplayAnalyser</code> SPIs; the in-built <code>CommandReplayAnalyserNumberBackgroundCommands</code> does precisely this.</p> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_detecting_failures">Detecting Failures</h3> 
         <div class="paragraph"> 
          <p>If the <em>slave</em> hits an issue when executing the command, then the process stops. The development team can check for a failure by either:</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p>executing "findReplayHwmOnSlave" action (on the <em>slave</em>)</p> 
            <div class="paragraph"> 
             <p>This returns the HWM with a mixed-in collection showing the most recently executed commands; or</p> 
            </div> </li> 
           <li> <p>monitoring the console/log of the <em>slave</em></p> 
            <div class="paragraph"> 
             <p>The LOG for <code>ReplayableCommandExecution</code> class will write out an info message if it has hit a replay error.</p> 
            </div> </li> 
          </ul> 
         </div> 
         <div class="paragraph"> 
          <p>If a command fails to replay then the development team can either exclude it or they can retry it (using mixin actions on the <code>CommandJdo</code> entity). If a command is excluded then the <em>slave</em>'s job will continue onto the next command. If a command is retried then the <em>slave</em> simply removes details of the failure condition, and attempts again.</p> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_hints_and_tips">Hints and Tips</h3> 
         <div class="paragraph"> 
          <p>There are several reasons why a command may fail to replay.</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p>First and most obviously, the <em>master</em> and <em>slave</em> must be compatible with each other.</p> 
            <div class="paragraph"> 
             <p>If the <em>slave</em> has changed implementation (eg has a bug fix or new feature) which produces different results, then replaying a command is expected to fail to replay. Indeed, this could be considered a successful test because it confirms that the <em>slave</em> implementation is indeed different. Providing appropriate implementations of <code>CommandReplayAnalyser</code> will allow useful information about the variation to be obtained.</p> 
            </div> </li> 
           <li> <p>the <code>Command</code> memento captures the target and object references as "OIDs", which encodes the object type (alias for the concrete class) as well as its identity.</p> 
            <div class="paragraph"> 
             <p>If database-generated surrogate/artificial keys are in use, then sequencing becomes important. Indeed, this is the main reason that the replication job only works one command at a time, to minimize the chance that the replay happens in a different order to that of the <em>slave</em>.</p> 
            </div> 
            <div class="paragraph"> 
             <p>For more reliability of replays (but arguably more complexity), consider using business natural keys.</p> 
            </div> </li> 
           <li> <p>A related and more severe issue is if the identity of objects is specified using a random UUID. Unless the generation of such UUIDs is made deterministic, replaying such commands is unlikely to be do-able.</p> </li> 
          </ul> 
         </div> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_implementation">Implementation</h2> 
       <div class="sectionbody"> 
        <div class="sect2"> 
         <h3 id="_classpath">Classpath</h3> 
         <div class="paragraph"> 
          <p>Update your classpath by adding this dependency in your webapp project’s <code>pom.xml</code>:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.isisaddons.module.command<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>isis-module-command-replay<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.16.1<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> 
          </div> 
         </div> 
         <div class="paragraph"> 
          <p>Check for later releases by searching <a href="http://search.maven.org/#search|ga|1|isis-module-command-replay">Maven Central Repo</a>.</p> 
         </div> 
         <div class="paragraph"> 
          <p>For instructions on how to use the latest <code>-SNAPSHOT</code>, see the <a href="../../../pages/contributors-guide/contributors-guide.html">contributors guide</a>.</p> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_bootstrapping">Bootstrapping</h3> 
         <div class="paragraph"> 
          <p>In the <code>AppManifest</code>, update its <code>getModules()</code> method, eg:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Class</span>&lt;?&gt;&gt; getModules() {
    <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.asList(
            ...
            org.isisaddons.module.command.replay.CommandReplayModule.class,
    );
}</code></pre> 
          </div> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_configuration_properties">Configuration Properties</h3> 
         <div class="paragraph"> 
          <p>The <em>master</em> and the <em>slave</em> are distinguished simply by the presence of a number of configuration properties on the <em>slave</em>:</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p><code>isis.command.replay.master.user</code></p> </li> 
           <li> <p><code>isis.command.replay.master.password</code></p> </li> 
           <li> <p><code>isis.command.replay.master.baseUrl</code></p> 
            <div class="paragraph"> 
             <p>For example <code><a href="http://localhost:8080/restful/" class="bare">http://localhost:8080/restful/</a></code></p> 
            </div> </li> 
          </ul> 
         </div> 
         <div class="paragraph"> 
          <p>These allow the <em>slave</em> to query the <em>master</em> through its REST API.</p> 
         </div> 
         <div class="paragraph"> 
          <p>There are also two optional configuration properties:</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p><code>isis.command.replay.master.baseUrlEndUser</code></p> 
            <div class="paragraph"> 
             <p>If configured, this contributes a mixin on <code>CommandJdo</code> entity to open a new web browser tab on the <em>master</em> for the same entity. This can be helpful for debugging a command that has failed to replay.</p> 
            </div> 
            <div class="paragraph"> 
             <p>For example <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>.</p> 
            </div> 
            <div class="admonitionblock note"> 
             <table> 
              <tbody>
               <tr> 
                <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> 
                <td class="content"> 
                 <div class="paragraph"> 
                  <p>Note that this can’t necessarily be derived from the <code>isis.command.replay.master.baseUrl</code> configuration property; the <em>slave</em> may communicate with <em>master</em> using a different network to the one used by the end-user’s web browser (eg if Docker stacks are in use).</p> 
                 </div> </td> 
               </tr> 
              </tbody>
             </table> 
            </div> </li> 
           <li> <p><code>isis.command.replay.master.batchSize</code></p> 
            <div class="paragraph"> 
             <p>The <em>slave</em> executes only one command at a time, but it actually requests to fetch several commands. This is because (because of the <code>CommandDtoProcessor</code> SPI) not every command is necessarily replicated. The batch size is intended to ensure that "enough" commands are requested that at least one is returned.</p> 
            </div> </li> 
          </ul> 
         </div> 
         <div class="paragraph"> 
          <p>On the <em>slave</em> it might sometimes be worth specifying a different manifest (using <code>isis.appManifest</code> configuration property), for example to disable publishing module.</p> 
         </div> 
        </div> 
        <div class="sect2"> 
         <h3 id="_quartz_job">Quartz job</h3> 
         <div class="paragraph"> 
          <p>The commands themselves are replayed through the <code>RunBackgroundCommandsWithReplicationAndReplayJob</code> job, scheduled using Quartz. This job <em>replaces</em> the <code>RunBackgroundCommandsJob</code> that is usually used to run background jobs; it runs on both <em>master</em> and <em>slave</em>:</p> 
         </div> 
         <div class="ulist"> 
          <ul> 
           <li> <p>if the job is run on the <em>master</em> then it simply does the same thing as the old <code>RunBackgroundCommandsJob</code></p> </li> 
           <li> <p>if the job is run on the <em>slave</em>, then it uses the REST API to copy commands from the <em>master</em> to <em>slave</em>, and executes. This continues until all commands have been copied and executed.</p> </li> 
          </ul> 
         </div> 
         <div class="paragraph"> 
          <p>The job determines whether it is running on <em>master</em> or <em>slave</em> simply by checking for the presence of the configuration properties listed above.</p> 
         </div> 
         <div class="paragraph"> 
          <p>The quartz configuration should be something like:</p> 
         </div> 
         <div class="listingblock"> 
          <div class="title">
           quartz-config.xml
          </div> 
          <div class="content"> 
           <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job-scheduling-data</span> <span class="attribute-name">...</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">"</span><span class="content">1.8</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;schedule&gt;</span>
    ...
    <span class="tag">&lt;job&gt;</span>
      <span class="tag">&lt;name&gt;</span>RunBackgroundCommandsWithReplicationAndReplayJob<span class="tag">&lt;/name&gt;</span>
      <span class="tag">&lt;group&gt;</span>CommandModule<span class="tag">&lt;/group&gt;</span>
      <span class="tag">&lt;description&gt;</span>
        Retrieves executed commands (as XML) from master and
        persists as new unexecuted commands on slave
      <span class="tag">&lt;/description&gt;</span>
      <span class="tag">&lt;job-class&gt;</span>
org.isisaddons.module.command.replay.impl.RunBackgroundCommandsWithReplicationAndReplayJob
      <span class="tag">&lt;/job-class&gt;</span>
      <span class="tag">&lt;job-data-map&gt;</span>
        <span class="tag">&lt;entry&gt;</span>
          <span class="tag">&lt;key&gt;</span>user<span class="tag">&lt;/key&gt;</span>
          <span class="tag">&lt;value&gt;</span>scheduler_user<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/entry&gt;</span>
        <span class="tag">&lt;entry&gt;</span>
          <span class="tag">&lt;key&gt;</span>roles<span class="tag">&lt;/key&gt;</span>
          <span class="tag">&lt;value&gt;</span>admin_role<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/entry&gt;</span>
      <span class="tag">&lt;/job-data-map&gt;</span>
    <span class="tag">&lt;/job&gt;</span>
    <span class="tag">&lt;trigger&gt;</span>
      <span class="tag">&lt;cron&gt;</span>
        <span class="tag">&lt;name&gt;</span>RunBackgroundJobsEvery10Seconds<span class="tag">&lt;/name&gt;</span>
        <span class="tag">&lt;job-name&gt;</span>RunBackgroundCommandsWithReplicationAndReplayJob<span class="tag">&lt;/job-name&gt;</span>
        <span class="tag">&lt;job-group&gt;</span>CommandModule<span class="tag">&lt;/job-group&gt;</span>
        <span class="tag">&lt;cron-expression&gt;</span>0/10 * * * * ?<span class="tag">&lt;/cron-expression&gt;</span>
      <span class="tag">&lt;/cron&gt;</span>
    <span class="tag">&lt;/trigger&gt;</span>
    ...
  <span class="tag">&lt;/schedule&gt;</span>
<span class="tag">&lt;/job-scheduling-data&gt;</span></code></pre> 
          </div> 
         </div> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_manual_debugging">Manual Debugging</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>By default the quartz job (details below) which replicates commands starts immediately when the webapp is bootstrapped, polling for commands to replicate from master to slave.</p> 
        </div> 
        <div class="paragraph"> 
         <p>Optionally the job can be paused by implementing the <code>ReplayCommandExecutionController</code> SPI:</p> 
        </div> 
        <div class="listingblock"> 
         <div class="content"> 
          <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ReplayCommandExecutionController</span> {
    <span class="type">enum</span> State {
        RUNNING,
        PAUSED
    }
    State getState();       <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre> 
         </div> 
        </div> 
        <div class="colist arabic"> 
         <table> 
          <tbody>
           <tr> 
            <td><i class="conum" data-value="1"></i><b>1</b></td> 
            <td>The current state, or <code>null</code> if the service implementing this SPI has not yet been initialized.</td> 
           </tr> 
          </tbody>
         </table> 
        </div> 
        <div class="paragraph"> 
         <p>If an implementation has been provided then the state will be checked. Unless "RUNNING" is returned, the replay job will do nothing.</p> 
        </div> 
        <div class="paragraph"> 
         <p>This can be useful if wishing to manually debug replication. With the replay job paused, commands can instead be manually copied from <em>master</em> to <em>slave</em> using the "download" and "upload" actions, and then executed one at a time:</p> 
        </div> 
        <div class="ulist"> 
         <ul> 
          <li> <p>On the <strong><em>slave</em></strong>, use <code>findReplayHwmOnSlave</code> action (from the <code>CommandReplayOnSlaveService</code>) to obtain the "high water mark".</p> 
           <div class="paragraph"> 
            <p>If the backup has just been restored, then this will be the most recent foreground command that was run on the production system before the backup was taken.</p> 
           </div> 
           <div class="paragraph"> 
            <p>If any commands have been replayed, then this will be that most recent replayed command.</p> 
           </div> </li> 
          <li> <p>Use the "replayNext" mixin action on the <code>Command</code>. This performs the same general steps as the replay job, but for a single command:</p> 
           <div class="ulist"> 
            <ul> 
             <li> <p>it fetches the next command via REST</p> </li> 
             <li> <p>persists the command</p> </li> 
             <li> <p>executes the command</p> </li> 
             <li> <p>executes any resultant background commands</p> </li> 
             <li> <p>analyses the result.</p> </li> 
            </ul> 
           </div> </li> 
         </ul> 
        </div> 
        <div class="paragraph"> 
         <p>This "replayNext" action also returns the next command retrieved. Therefore, the administrator/developer can continue to invoke "replayNext" on each successive command.</p> 
        </div> 
        <div class="paragraph"> 
         <p>There are also a couple of other actions that are worth being aware of:</p> 
        </div> 
        <div class="ulist"> 
         <ul> 
          <li> <p>On the <em>master</em>, the <code>downloadCommandsOnMasterSince</code> action returns the commands in XML format, where the "since" is intended to be the transaction id of the high water mark obtained from the slave</p> </li> 
          <li> <p>On the <em>slave</em>, the <code>uploadCommandsToSlave</code> action allows XML commands to be persisted on the slave.</p> </li> 
         </ul> 
        </div> 
       </div> 
      </div> 
      <div class="sect1"> 
       <h2 id="_dependencies">Dependencies</h2> 
       <div class="sectionbody"> 
        <div class="paragraph"> 
         <p>Maven can report modules dependencies using:</p> 
        </div> 
        <div class="listingblock"> 
         <div class="content"> 
          <pre class="CodeRay highlight"><code data-lang="bash">mvn dependency:list -o -pl modules/spi/command/replay -D excludeTransitive=true</code></pre> 
         </div> 
        </div> 
        <div class="paragraph"> 
         <p>which, excluding Apache Isis itself, returns these compile/runtime dependencies on other modules in the Incode platform:</p> 
        </div> 
        <div class="listingblock"> 
         <div class="content"> 
          <pre class="CodeRay highlight"><code data-lang="bash">org.incode.module.jaxrsclient:incode-module-jaxrsclient-dom
org.isisaddons.module.quartz:isis-module-quartz-dom</code></pre> 
         </div> 
        </div> 
        <div class="paragraph"> 
         <p>For further details on these dependencies, see:</p> 
        </div> 
        <div class="ulist"> 
         <ul> 
          <li> <p><a href="../../lib/jaxrsclient/lib-jaxrsclient.html">JAX-RS Client library</a></p> </li> 
          <li> <p><a href="../../ext/quartz/ext-quartz.html">Quartz extension</a></p> </li> 
         </ul> 
        </div> 
       </div> 
      </div> 
     </div> 
    </div> 
    <div class="hidden-xs hidden-sm hidden-md col-lg-3"> 
     <nav id="toc" data-spy="affix" data-toggle="toc"></nav> 
    </div> 
   </div> 
  </div> 
  <footer class="footer"> 
   <div class="container"> 
    <div class="row"> 
     <p class="text-center small text-muted"> Copyright © 2012~date Dan Haywood, licensed under the Apache&nbsp;License,&nbsp;v2.0. </p> 
    </div> 
   </div> 
  </footer> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> 
  <script src="../../../js/bootstrap/3.3.7/bootstrap.min.js"></script> 
  <script src="../../../js/bootstrap-toc/0.4.1/bootstrap-toc.min.js"></script> 
  <script src="../../../js/slick/1.5.0/slick.min.js"></script> 
  <script src="../../../js/elasticlunr/elasticlunr.min.js"></script> 
  <script src="../../../js/sticky-header/sticky-header.js"></script> 
  <script src="../../../js/search-panel/search-panel.js"></script> 
  <script src="../../../js/header-link/header-link.js"></script> 
  <script src="../../../js/toc-scroll/toc-scroll.js"></script>  
 </body>
</html>
